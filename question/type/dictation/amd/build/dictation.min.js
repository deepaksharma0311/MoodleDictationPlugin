define(["jquery"],function(t){"use strict";var n=0,e=0,i=!0;return{init:function o(a,r,u,d){e=r||0,i=u,t(document).ready(function(){var o,r,u=t("#q"+a);0===u.length&&(u=t(".qtype_dictation").first()),u.length>0&&(function t(o,a){var r=o.find("audio").first(),u=o.find(".audio-play-btn"),d=o.find(".dictation-play-counter"),f=o.find('input[name*="playcount"]'),c=o.attr("id")||"default",l=!1,s=!1;if(0===r.length||!i){o.find(".audio-controls").hide();return}var $=0;f.length>0&&f.val()&&($=parseInt(f.val())||0);var p="dictation_playcount_"+c+"_"+a;function m(){return 0==e||!!(n<e)}function v(){m()?(u.prop("disabled",!1),u.find(".btn-text").text("Play Audio")):(u.prop("disabled",!0),u.find(".btn-text").text("Play limit reached"))}function y(){d.length>0&&(e>0?d.text(n+" / "+e):d.text(n))}function g(){f.length>0&&f.val(n),localStorage.setItem(p,n.toString())}n=Math.max($,parseInt(localStorage.getItem(p))||0),g(),v(),y(),u.on("click",function(t){t.preventDefault(),m()&&r[0]&&m()&&r[0].play().catch(function(t){console.error("Audio play failed:",t)})}),r.on("play",function(){s||(n++,s=!0,l=!0,g(),v(),y())}),r.on("ended",function(){s=!1,l=!1}),r.on("pause",function(){s=!1,l=!1}),r.on("error",function(){console.error("Audio failed to load"),u.prop("disabled",!0).text("Audio Error"),s=!1,l=!1}),window.addEventListener("beforeunload",function(){l&&localStorage.setItem(p,n.toString())}),localStorage.setItem(p+"_timestamp",Date.now().toString()),function t(){for(var n=Object.keys(localStorage),e=Date.now()-864e5,i=0;i<n.length;i++){var o=n[i];if(o.startsWith("dictation_playcount_")&&o!==p){var a=localStorage.getItem(o+"_timestamp");(!a||parseInt(a)<e)&&(localStorage.removeItem(o),localStorage.removeItem(o+"_timestamp"))}}}()}(u,d),(r=(o=u).find('input[type="text"][name*="gap"]')).on("focus",function(){t(this).addClass("gap-focused")}),r.on("blur",function(){t(this).removeClass("gap-focused")}),r.on("keydown",function(t){if("Enter"===t.key){t.preventDefault();var n=r.index(this),e=r.eq(n+1);e.length>0&&e.focus()}}))})}}});